# NAT

(Network Address Translation)网络地址转换

## NAPT

(Network Address Port Translation)网络地址端口转换

假设私网HostA要访问公网Server的WWW服务

- HostA产生目的地为Server的报文，发送给网关

  - 报文的源地址和源端口为：10.0.0.1:1024
  - 目的接收端口为198.76.29.4:80

- 由于网关配置了NAPT，因此需要将私网IP和端口10.0.0.1:1024转换成公网地址和端口

  - RTA从公网池(198.76.28.11~198.76.28.20)中查找第一个可用的公网地址198.76.28.11，来替换源IP地址；并查找该公网地址的一个可用端口，2001。用这个端口替换源端口
  - 转换后的报文地址为：198.76.28.11:2001
  - 同时，网关在自己的表中添加一个表项(10.0.0.1:1024 ->198.76.11:2001)，并记录到映射表中
  - 然后网关将报文转发到目的地

- Server收到处理完报文后，发送回应报文

  192.76.29.4:80 -> 198.76.28.11:2001

- 网关收到报文

  - 发现报文目的地在自己的地址池中
  - 找映射表
  - 找到之后用对应的私网ip和端口来替换公网ip和端口

- HostA收到报文，地址转换过程结束

- 如果这时，HostB也要访问Server，则网关可用从地址池中为其分配同一个可用的公网地址，**但是分配另一个端口3001**，并在映射表中做记录。

NAPT通过这种方法节约了公网地址。

简单的讲，如何你和你的同事都用公司的网络访问百度，那么网关可以使用同一公网ip但是不同的端口号来替换你俩的私网ip和私网端口号，NAPT无非就是将外网的ip及端口和内网的ip及端口建立一个映射关系。

**由于NAT只能由内网向外发送数据包的时候建立绑定，而正常情况下外部的机器是不能直接连接到内网设备上的，这也就导致了子网内部的机器是不能用来当作服务器的。**

## NAT分类

- 锥形NAT

  - 完全锥形NAT

    如果NAT网关已经建立了一个NAT映射，那么任何外网的机器都可以通过这个映射来映射访问内网的电脑；

  - 限制锥形NAT

    - IP限制型锥形NAT

      如果NAT网关已经建立了一个NAT的映射，那么只有与其建立映射的ip才能通过NAT访问内网的电脑

    - 端口限制型NAT

      在限制ip的基础上，还限制端口，也就是说，NAT只会接受映射表中存在的ip和端口的信息

  锥形网络的特点：

  如果源服务使用同样的端口和不同的服务或相同的服务但不同端口建立连接的时候，NAT的映射会使用同样的端口和源端口进行映射。

- 对称型NAT

  首先，和端口限制型锥形是一样的，也是对ip和端口同是进行了限制。

  对称型NAT在A主动使用相同的端口去和不同服务器或和相同的服务器不同的端口建立连接时，NAT网关会给其重新分配一个端口。

  对于对称型NAT，在源电脑看来，他是使用同一个端口在和外界的不同服务进行通信的，但是在外界的两个server看来，它们认为他们和同一个网关的两个不同的端口在进行通信。

## 内网穿透

内网穿透是对两台处于NAT中的主机进行连接，所以上述4种类型，进行两两组合，共有10种组合方式，不同组合在进行穿透时的方法也不同，甚至存在两种组合方式无法进行内网穿透：端口受限型和对称型；对称型和对称型

准备工作：需要一台中心服务来帮助，A、B都需要先连接上这个中心服务器，叫Server

- 第一种：完全锥形NAT和完全锥形NAT进行穿透

  A、B连接到中间服务器Server之后，A、B都可以借助server的转发相互发送消息，A可以借助server看到B的公网ip和端口，B网关建立了B公网IP/端口和B私网IP端口的映射，**且完全锥形NAT任何外网都可以通过映射来访问内网**，这样的情况下，二者建立UDP连接进行通信

- 第二种：IP限制型NAT和IP限制型NAT进行通信

  A会先发送一个UDP请求到B的公网ip上，但是B的NAT网关中，200端口没有建立NAT映射，所以这个数据包会被丢弃，但是A发送B UDP请求之后，邀请B也发送一个UDP请求给A。

  注意，在B收到来自A的UDP请求后，虽然A的数据包被B丢弃了，但是此刻，网关A暂时的建立了一个NAT映射，等待B返回的信息，虽然数据包已经被丢弃了，但是A不知道，所以A会稍微等一会B。这时，B收到了A的邀请，给A发送了一个建立连接的请求，此刻**A的NAT网关恰巧暂时建立了NAT映射**，所以A就可以收到B的UDP请求，接着A会给B发送一个同意建立连接的请求，因为此刻B刚发完请求在等A的回信，所以B的NAT网关也会暂时的建立一个NAT映射，所以A同意建立连接的请求就不会被B的NAT网关丢弃，最终，二者就建立了一个稳定的UDP连接。 

- 第三种：端口限制型NAT和端口限制型NAT进行穿透

  原理和第二种差不多

可以发现锥形NAT中，A主机可以通过Server了解到B发送请求的公网端口(B的请求报头)，也可以知道自己发送请求的公网端口(A的请求报头)，但是到对称NAT中，由于一个连接对应一个网关端口，所以A无法确定自己通过那一个端口给B信息，同样也无法确定B会通过哪个端口给自己发送信息，所以无法建立连接。

而端口限制型对对方的端口有所要求，所以当对方是对称型NAT的时候，共计65535个端口，对方的端口并不一定满足需求。

目前来看的话，家里的路由器（包括办宽带时送的光猫），使用的都是完全锥型NAT，但是上层的机房为了公共安全，使用的一般都是对称NAT，也就说是我们绝大多数人使用的都是对称NAT，所以想要进行内网穿透还是非常困难的。

## References

1. https://www.bilibili.com/read/cv6189209/
