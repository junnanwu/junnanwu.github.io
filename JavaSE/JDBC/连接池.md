## 连接池

Java为数据库连接池提供了公共的接口：**javax.sql.DataSource**，各个厂商需要让自己的连接池实现这个接口。这样应用程序可以方便的切换不同厂商的连接池

常见的连接池：C3P0、DRUID

### C3P0

C3P0开源免费的连接池！目前使用它的开源项目有：Spring、Hibernate等。使用C3P0连接池需要导入jar包，c3p0使用时还需要添加配置文件“c3p0-config.xml” 

使用步骤：

1. 添加jar包

   两个`c3p0-0.9.5.2.jar`和`mchange-commons-java-0.2.12.jar`(数据连接池的辅助包)

2. 编写配置文件c3p0-config.xml，放在src中（文件名不能写错）

   ```xml
   <c3p0-config>
       <!-- 使用默认的配置读取连接池对象 -->
       <default-config>
           <!--  连接参数 -->
           <property name="driverClass">com.mysql.jdbc.Driver</property>
           <property name="jdbcUrl">jdbc:mysql://localhost:3306/day06</property>
           <property name="user">root</property>
           <property name="password">root</property>
   
           <!-- 连接池参数 -->
           <property name="initialPoolSize">5</property>
           <property name="maxPoolSize">10</property>
           <property name="checkoutTimeout">2000</property>
           <property name="maxIdleTime">1000</property>
   
           <!--记得添加下面这些信息，不然就会-->
           <!-- 当连接池耗尽时候，一次获得连接数-->
           <property name="acquireIncrement" value="5" />
           <property name="maxStatements" value="0" />
           <!-- 当连接池连接耗尽时，客户端getConnection(),所等待的时间-->
           <property name="checkoutTimeout" value="20000"/>
           <property name="idleConnectionTestPeriod" value="120" />
           <!-- 当连接失效时，获得连接的次数，0为无限次（重连）-->
           <property name="acquireRetryAttempts" value="30" />
       </default-config>
   </c3p0-config>
   ```

3. 编写工具类

```java
package com.itheima.c3p0;

import com.mchange.v2.c3p0.ComboPooledDataSource;

import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;

public class C3P0Utils {
    //创建数据源对象
    private static ComboPooledDataSource dataSource;

    static{
        dataSource = new ComboPooledDataSource();
    }

    public static ComboPooledDataSource getDataSource(){
        return dataSource;
    }

    public static Connection getConnection(){
        Connection connection = null;
        try {
            connection = dataSource.getConnection();
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return connection;
    }

    public static void close(Connection connection, Statement statement, ResultSet resultSet) {
        if (resultSet != null) {
            try {
                resultSet.close();
            } catch (SQLException e) {
                e.printStackTrace();
            }
        }

        if (statement != null) {
            try {
                statement.close();
            } catch (SQLException e) {
                e.printStackTrace();
            }
        }

        if (connection != null) {
            try {
                connection.close();
            } catch (SQLException e) {
                e.printStackTrace();
            }
        }
    }
}
```

### Druid

Druid是阿里巴巴开发的号称为监控而生的数据库连接池，Druid是国内目前最好的数据库连接池。在功能、性能、扩展性方面，都超过其他数据库连接池。Druid已经在阿里巴巴部署了超过600个应用，经过一年多生产环境大规模部署的严苛考验。如：一年一度的双十一活动，每年春运的抢火车票。

Druid的下载地址：<https://github.com/alibaba/druid>

DRUID连接池使用的jar包：`druid-1.1.16.jar`

步骤:

1. 导入DRUID jar 包
2. 拷贝配置文件到src目录
3. 根据配置文件 创建连接池对象
4. 从连接池对象获得连接

```java
public class DruidUtils {
    private static DataSource dataSource;
    static {
        //加载properties文件
        //Druid需要传入properties参数，所以不能使用ResourceBundle
        //ResourceBundle conf = ResourceBundle.getBundle("druid");
        //需要使用传统的方式
        /*Properties properties = new Properties();
        try {
            properties.load(new FileInputStream(new File("connectionPool/src/druid.properties")));
        } catch (IOException e) {
            e.printStackTrace();
        }
        System.out.println(properties);*/

        InputStream inputStream = DruidUtils.class.getClassLoader().getResourceAsStream("druid.properties");
        Properties properties = new Properties();
        try {
            properties.load(inputStream);
        } catch (IOException e) {
            e.printStackTrace();
        }
        System.out.println(properties);
        //创建Druid连接池对象
        try {
            dataSource = DruidDataSourceFactory.createDataSource(properties);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public static DataSource getDataSource(){
        return dataSource;
    }

    public static Connection getConnetion(){
        Connection connection = null;
        try {
            connection = dataSource.getConnection();
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return connection;
    }
}
```

关于`getResourceAsStream()`

```java
//默认则是从ClassPath根下获取，path不能以’/'开头，最终是由ClassLoader获取资源。 
InputStream inputStream = DruidUtils.class.getClassLoader().getResourceAsStream("druid.properties");
```

```java
//文件名前加了“/”，则表示从类路径下也就是从classes文件夹下查找资源
InputStream inputStream = DruidUtils.class.getResourceAsStream("/druid.properties");
```

## DBUtils

如果只使用JDBC进行开发，我们会发现冗余代码过多，为了简化JDBC开发，本案例我们讲采用apache commons组件一个成员：DBUtils

DBUtils就是JDBC的简化开发工具包。需要项目导入commons-dbutils-1.6.jar才能够正常使用DBUtils工具

DBUtils是java编程中的数据库操作实用工具，小巧简单实用。DBUtils封装了对JDBC的操作，简化了JDBC操作，可以少写代码。

Dbutils三个核心功能介绍

* QueryRunner中提供对sql语句操作的API.

* ResultSetHandler接口，用于定义select操作后，怎样封装结果集.

* DbUtils类，它就是一个工具类,定义了关闭资源与事务处理的方法

ResultSetHandler 结果集

DBUtils用的最多的就是其对于结果集的处理，仅仅得到一个ResultSet没什么用，而结果集的处理正是依赖于ResultSetHandler接口及其实现类

**ResultSetHandler接口就是将ResultSet结果集映射为Bean、List、Map等Java中的对象或者集合**

```java
/**
 * 此接口的实现将 ResultSet 转换为其他对象
 * T： 目标类型（类型参数），也就是 ResultSet 转换为的对象的类型
 */
public interface ResultSetHandler<T> {

    /**
     * 方法说明：将 ResultSet 转换为一个对象
     *
     * rs： 要转换的 ResultSet
     * T： 返回用 ResultSet 数据初始化的对象
     * 如果 ResultSet 包含0行，那么实现返回 null 也是合法的
     * 数据库访问出错将会抛出 SQLException 异常
     */
    T handle(ResultSet rs) throws SQLException;

}
```

```
处理单行数据的类：ScalarHandler、ArrayHandler、MapHandler、BeanHandler

处理多行数据的类：BeanListHandler、AbstractListHandler（ArrayListHandler、MapListHandler、ColumnListHandler）、AbstractKeyedHandler（KeyedHandler BeanMapHandler）
```

**BeanHandler**

```
将结果集中的第一行数据封装到一个对应的JavaBean实例中
```

```java
public class Demo01 {
    public static void main(String[] args) throws SQLException {
        QueryRunner queryRunner = new QueryRunner();
        Connection connetion = DruidUtils.getConnetion();
        Stu query = queryRunner.query(connetion, "select * from stu where sid = ?",new BeanHandler<>(Stu.class),1);
        System.out.println(query);
    }
}
```

**BeanListHandler**

```
将结果集中的每一行数据都封装到一个对应的JavaBean实例中，存放到List里
```

```java
public class Demo2_BeanlistHeandler {
    public static void main(String[] args) {
        QueryRunner queryRunner = new QueryRunner(DruidUtils.getDataSource());
        List<Stu> list = null;
        try {
            list = queryRunner.query("select *from stu", new BeanListHandler<>(Stu.class));
            list.forEach(System.out::println);
        } catch (SQLException e) {
            e.printStackTrace();
        }finally {
        }
    }
}
```

## 