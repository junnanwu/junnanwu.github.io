# 线程池参数选择

## 最佳线程数目

`最佳线程数目 = ((线程等待时间+线程CPU时间) / 线程CPU时间) * CPU数目`

此公式原理就是：CPU占总时间的比例即一个CPU可以处理的最大线程，再乘以线程数

例如：

CPU需要2s，IO操作需要8秒，线程1先占用2s CPU，接下来8s IO的时间，CPU可以分别去处理其他4个线程的CPU，一共也是8秒，正好线程1的IO操作完成，线程1继续占用2s CPU，也就是一共5个线程，2/ (2+8)。

## 举例

- 提交到线程池中的任务，IO耗时占比是90%，计算耗时占比10%，忽略提交到线程池中的任务数量，在4核8G的机器上，理想情况下线程池中创建多少个线程是最优的？

  按上述公式：

  `(0.9+0.1)/0.1*4 = 40`

  即40个最优。

- 假如有一类cpu密集性的任务，没有IO操作，日常的时候只有1个任务，流量高峰会有50个任务，4核8G的机器上，使用的线程池，如何设置？

  思路：

  - corePoolSize=1

    日常只需要一个任务，只需要一个线程常驻即可

  - new ArrayBlockingQueue(46)

    大小为46的的阻塞队列

  - maximumPoolSize=4

    最大线程数为核心数4

  行为：

  - 提交第一个任务，创建第一个线程
  - 当提交至第47个任务的时候，队列已满，会创建新线程，
  - 直到第50个任务的时候，创建出共4个线程共同进行处理
  - 一段时间以后，非核心线程都会被销毁，剩下一个核心线程

## References

1. http://ifeve.com/how-to-calculate-threadpool-size/
2. https://zhuanlan.zhihu.com/p/86433815
