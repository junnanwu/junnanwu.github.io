# Redis数据结构

## 字符串

Redis并没有使用C语言的字符串，而是使用SDS（Simple Dynamic String）。

SDS的结构如下：

```c
struct sdshdr {
	// 记录buf[]中已使用字节的数量
	int len;
	// 记录buf[]中未使用字节的数量
	int free;
	// 保存目标字符串
	char buf[];
};
```

而C语言使用长度为N+1的字符数组来表示长度为N的字符串，并且最后一个字符为空字符`\0`。

区别：

- SDS可以常数复杂度获取字符串的长度

  而C语言字符串复杂度为`O(N)`。

- 避免了缓冲区溢出 

  由于C字符串不记录本身的长度，所以在向字符串中追加内容的时候，就容易造成缓冲区溢出。

  而SDS要进行修改的时候，API会先检查SDS的空间是否满足需求，如果不满足 ，则自动将SDS的空间扩展至执行修改所需的大小，然后再执行修改操作。

- 减少修改字符串时带来的内存重分配次数

  C字符串进行增长或缩短的时候，总会对保存的这个字符串数组进行一次内存重分配操作，使得数组长度等于字符串长度加一，这一步时较为耗时的。

  而SDS中，buf的长度不一定 就是字符串数量加一，数据里面可以有未使用的字节，被`free`属性记录。

  通过未使用的字节，SDS实现了两种优化策略：

  - 空间预分配

    - 在对SDS进行修改之后，SDS的长度如果小于1MB，那么程序将给此SDS分配和len属性同等大小的未使用空间

    - 在对SDS进行修改之后，SDS的长度如果大于1MB，那么分配1MB的未使用空间

  - 惰性空间释放 

    当SDS字符串出现缩短操作的时候，程序并不立即使用内存重分配来回收这些字节，而是使用free属性将这些字节的数量记录起来，等待将来使用。

- 二进制安全

  C字符串中的字符必须符合某种编码，并字符串中不能包含空字符，否则会被认为字符串结束，所以不能保存图片、音频等二进制数据。

  而SDS就可以保存任何二进制数据，因为SDS通过len属性值而不是空字符来判断字符串是否结束。

## 字典

字典即Map。

与Java的Map类似，添加一个键值的时候，先通过键值的Hash值计算出在hash数组的索引位置，计算方式与Java类似：

```
hash & (size -1)
```

当遇到hash冲突，Redis哈希表用链地址法，即采用一个单链表来将同一索引位置的键值对连接起来。

## 跳跃表

跳跃表（Skip  List）是**有序集合**的底层实现之一，跳跃表的时间复杂度与平衡树类似，而是实现更加简单。

跳表是可以实现二分查找的有序链表。

跳表用于实现Redis的有序集合。

![skip_lists_example](Redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84_assets/skip_lists_example.png '一个跳跃表')

位于最左边的是zskiplist，该结构包括：

- header

  指向跳跃表的表头节点。

- tail

  指向跳跃表的表尾节点。

- level

  层数最大节点的层数。

- length

  总节点数。

位于右方的是四个zskiplistNode结构（第一个为表头节点），该结构包括：

- level

  节点中用L1、L2、L3来表示各个层，每个层都带有两个属性：前进指针和跨度。

  前进指针用于访问位于表尾方向的其他节点，而跨度则记录了前进指针所指向节点和当前节点的距离。

  在上面的图片中，连线上带有数字的箭头就代表前进指针，而那个数字就是跨度。当程序从表头向表尾进行遍历时，访问会沿着层的前进指针进行。

- 后退指针

  节点中用Bw字样标记节点的后退指针，它指向位于当前节点的前一个节点。后退指针在程序从表尾向表头遍历时使用。

- 分值

  各个节点中的1.0、2.0、3.0是节点所保存的分值。在跳跃表中，节点按各自所保存的分值从小到大排列。

- 成员对象

  各个 节点中的o1、o2、o3即为即为节点的成员对象。

如何查找：

例如查找跳跃表中分值为2.0的节点：

![image-20220702122015078](Redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84_assets/image-20220702122015078.png)

- 从head开始，到头节点L1，比较目标值2.0与L1的指向节点对应的值即1.0
- 2.0大于1，继续查找头节点L2、L3、L5直到L5发现，其指向节点的值3.0大于2.0
- 则查找节点2的L4、L3指向节点都为3.0，大于2.0，直至L2节点，值等于2.0

## References

1. 《Redis设计与实现》——黄健宏
2. https://www.jianshu.com/p/9d8296562806
3. https://juejin.cn/post/6893072817206591496