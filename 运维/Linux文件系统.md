# Linux文件系统

## 基本概念

### 挂载

挂载（mount），就是利用一个目录当成进入点，将磁盘分区槽的数据放置在该目录下，也就是说，进入该目录就可以读取该分区槽的意思。

这个动作我成称为**挂载**，这个目录我们称为**挂载点**。

例如：

我们将分区一挂载到`/`目录，分区二挂载在到`/home`目录下，这样当我们将数据放置在`/home`目录时，就是放置到了分区二，当放在其他目录的时候，就会被放在分区一。

## Ext文件系统

Linux中引进的最早的文件系统叫做拓展文件系统（Extended filesystem，简称Ext）。

最早的Ext文件系统有不少限制，比如文件大小不得超过2GB。在Linux出现后不久，Ext就升级到了第二代扩展文件系统，叫作Ext2。

Ext2的索引节点表为文件添加了创建时间值、修改时间值和最后访问时间值来帮助系统管理员追踪文件的访问情况。Ext2文件系统还将允许的最大文件大小增加到了2TB。

文件数据处了文件的实际内容外，通常还含有非常多的属性，例如文件权限（rwx）和文件属性（拥有者、群组、时间参数等）。

文件系统通常会将这两部分分别存在不同的区块中。另外还有一个超级区块（superblock）会记录整个文件系统的整体信息。

- superblock

  记录此filesystem的整体信息，包括inode与block的总量、使用量、剩余量等。

- inode

  记录文件的属性，一个文件占用一个inode，同时记录此文件所在的block号码

- block

  记录文件的实际内容

文件系统一开始就将inode与block规划好了，除非重新格式化，否则inode和block固定后就不会再变动。

### block

在Ext文件系统中所支持的block大小有1K，2K及4K三种。在格式化的时候，block的大小就固定了，且每个block都有编号，已方便inode进行记录。

| Bolck大小          | 1KB  | 2KB   | 4KB  |
| ------------------ | ---- | ----- | ---- |
| 最大单一文件限制   | 16GB | 256GB | 2TB  |
| 最大文件系统总容量 | 2TB  | 8TB   | 16TB |

block的限制：

- block的大小与数量在格式化之后是不能再改变的
- 每个block内最多只能放置一个文件的数据
- 如果文件大于block的大小，那么一个文件将占用多个block的数量
- 如果文件数量小于block的大小，那么block的剩余空间就不能再使用了

由于现在的磁盘容量很大，所以block大小基本都是4K，这种情况下，如果有很多小文件将浪费大量的磁盘空间。

例如：

系统中有10000个小文件，每个大小均为50bytes，这个时候，所有文件的容量为50bytes × 10000 = 488.3Kbytes

但是此时浪费的容量为(4096bytes-50) × 10000 = 38.6MBytes，即不到1MB的文件浪费将尽40MB的容量。

### inode

inode记录的内容包括：

- 该文件的权限
- 该文件的属主和属组
- 该文件的容量
- 该文件建立或者状态改变的时间
- 最近一次读取的时间
- ...

inode的特点：

- 每个inode大小均为128bytes
- 每个文件仅会占用一个inode
- 文件读取的时候会先读取inode，进行权限的匹配，符合的才读取对应block内容

inode要记录的数据非常多，但是只有128bytes，而记录一个block号码要花掉4bytes，inode的128bytes是如何存储那么多的block号码的呢？

- inode里面有12个直接指向block号码的对照，直接指向能直接取得block号码

- 1个间接就，间接就是再拿一个block来当作记录block号码的记录
- 1个双间接，就是两级block
- 1个三间接，就是三级block

通过这种方式，1K的block单个文件最大可以为16GB。

### Superblock

Superblock是记录整个filesystem相关信息的地方。

记录的主要信息有：

- block与inode的总量
- 未使用和已使用的inode/block数量
- block与inode的大小
- filesystem的挂载时间、最后一次写入数据时间...

## 与目录树的关系

**目录**

当我们在Linux下的文件系统建立一个目录时，文件系统会分配一个inode与至少一块block给该目录。

其中inode记录该目录的相关权限与属性，并记录分配到的block的号码，而block则是记录这个目录下的文件名与该文件名占用的inode数据。

**文件**

当我们在Linux下的ext2下建立一个一般文件时，ext2会分配一个inode与相当大小的block数量给该文件。

**目录树读取**

由于目录树是由根目录开始读起，因此系统通过挂载的信息可以找到挂载点的inode的号码，此时就能够得到根目录inode内容，并依据该inode读取根目录的block内的文件名数据，再一层一层的往下读到正确的文件。

## Reference

- 《鸟哥的Linux私房菜》

